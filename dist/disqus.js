/*! DisqusJS v1.3.0 | Sukka (https://skk.moe) | https://disqusjs.skk.moe | MIT License */"use strict";exports.__esModule=!0,exports.default=void 0;var $$=function(s){return document.getElementById(s)},setLS=function(s,e){try{localStorage.setItem(s,e)}catch(s){console.log(s)}},CLICK="click",DISQUS_CONTAINER_EL_ID="disqus_thread",DSQJS_STORAGE_KEY_SORT_TYPE="dsqjs_sort",HTML_TPL_A_ATTR='target="_blank" rel="external nofollow noopener noreferrer"',HTML_TPL_EL_MSG='<div id="dsqjs-msg"></div>',HTML_TPL_EL_FOOTER='<footer><p class="dsqjs-footer">Powered by <a class="dsqjs-disqus-logo" href="https://disqus.com" '+HTML_TPL_A_ATTR+'></a>&nbsp;&amp;&nbsp;<a href="https://disqusjs.skk.moe" target="_blank">DisqusJS</a></p></footer>',HTML_TPL_EL_HEADER=function(s,e){return'<header class="dsqjs-header" id="dsqjs-header"><nav class="dsqjs-nav dsqjs-clearfix"><ul><li class="dsqjs-nav-tab dsqjs-tab-active"><span>'+s+' Comments</span></li><li class="dsqjs-nav-tab">'+e+'</li></ul><div class="dsqjs-order"><input class="dsqjs-order-radio" id="dsqjs-order-desc" type="radio" name="comment-order" value="desc" checked="true"><label class="dsqjs-order-label" for="dsqjs-order-desc" title="按从新到旧">最新</label><input class="dsqjs-order-radio" id="dsqjs-order-asc" type="radio" name="comment-order" value="asc"><label class="dsqjs-order-label" for="dsqjs-order-asc" title="按从旧到新">最早</label><input class="dsqjs-order-radio" id="dsqjs-order-popular" type="radio" name="comment-order" value="popular"><label class="dsqjs-order-label" for="dsqjs-order-popular" title="按评分从高到低">最佳</label></div></nav></header>'},HTML_TPL_EL_COMMENT=function(s,e,t){var n=s.avatarEl,o=s.createdAt;return'<div class="dsqjs-post-item dsqjs-clearfix"><div class="dsqjs-post-avatar">'+n+'</div><div class="dsqjs-post-body"><div class="dsqjs-post-header">'+e+'<span class="dsqjs-meta"><time>'+formatDate(o)+'</time></span></div><div class="dsqjs-post-content">'+t+"</div></div></div>"},HTML_TPL_EL_ASK_FOR_FULL='如需完整体验请针对 disq.us | disquscdn.com | disqus.com 启用代理并 <a id="dsqjs-reload-disqus" class="dsqjs-msg-btn">尝试完整 Disqus 模式</a> | <a id="dsqjs-force-disqus" class="dsqjs-msg-btn">强制完整 Disqus 模式</a>',formatDate=function(s){function e(s){return s<10?"0"+s:s}return s=Date.parse(new Date(s).toString()),(s=new Date(s+288e5)).getFullYear()+"-"+e(s.getMonth()+1)+"-"+e(s.getDate())+" "+e(s.getHours())+":"+e(s.getMinutes())},DisqusJS=function(){function s(s){var e=document.location.origin+document.location.pathname+document.location.search;this.config=Object.assign({api:"https://disqus.skk.moe/disqus/",identifier:e,url:e,title:document.title,siteName:"",nesting:parseInt(s.nesting)||4,nocomment:"这里冷冷清清的，一条评论都没有"},s),this.page={};var t=this;window.disqus_config=function(){this.page.url=t.config.url,this.page.identifier=t.config.identifier,this.page.title=t.config.title},$$(DISQUS_CONTAINER_EL_ID).innerHTML='<div id="dsqjs">'+HTML_TPL_EL_MSG+HTML_TPL_EL_FOOTER+"</div>",fetch&&localStorage&&Promise?this.initDsqjs():(this.msg("你的浏览器版本过低，不兼容评论基础模式。"+HTML_TPL_EL_ASK_FOR_FULL),this.assignClickEventForAskForFulButton())}var e=s.prototype;return e.msg=function(s){var e=$$("dsqjs-msg");e&&(e.innerHTML=s)},e._get=function(s){return fetch(s).then(function(s){return Promise.all([s.ok,s.status,s.json(),s.headers])}).then(function(s){var e=s[0],t=s[1],n=s[2],o=s[3];if(e)return{ok:e,status:t,data:n,headers:o};throw new Error}).catch(function(s){throw s})},e.loadDisqus=function(){if(window.DISQUS){var s=this.config,e=s.identifier,t=s.url,n=s.title;window.DISQUS.reset({reload:!0,config:function(){this.page.identifier=e,this.page.url=t,this.page.title=n}})}else{var o=document.createElement("script");$$(DISQUS_CONTAINER_EL_ID).innerHTML='<div id="dsqjs"><section><div id="dsqjs-msg">评论完整模式加载中... 如果长时间无法加载，请针对 disq.us | disquscdn.com | disqus.com 启用代理，或切换至 <a id="dsqjs-force-dsqjs" class="dsqjs-msg-btn">评论基础模式</a></div></section>'+HTML_TPL_EL_FOOTER+"</div>",$$("dsqjs-force-dsqjs").addEventListener(CLICK,this.useDsqjs),o.src="https://"+this.config.shortname+".disqus.com/embed.js",o.setAttribute("data-timestamp",(new Date).valueOf().toString()),(document.head||document.body).appendChild(o)}},e.checkDisqus=function(){$$(DISQUS_CONTAINER_EL_ID).innerHTML='<div id="dsqjs"><section><div id="dsqjs-msg">正在检查 Disqus 能否访问...</div></section>'+HTML_TPL_EL_FOOTER+"</div>";function s(o){return new Promise(function(s,e){var t=new Image,n=setTimeout(function(){t.onerror=t.onload=null,e()},3e3);t.onerror=function(){clearTimeout(n),e()},t.onload=function(){clearTimeout(n),s()},t.src="https://"+o+"/favicon.ico?"+ +new Date+"="+ +new Date})}return Promise.all([s("disqus.com"),s(this.config.shortname+".disqus.com")]).then(this.useDisqus,this.useDsqjs)},e.useDsqjs=function(){setLS("dsqjs_mode","dsqjs"),this.loadDsqjs()},e.useDisqus=function(){setLS("dsqjs_mode","disqus"),this.loadDisqus()},e.assignClickEventForAskForFulButton=function(){$$("dsqjs-reload-disqus").addEventListener(CLICK,this.checkDisqus),$$("dsqjs-force-disqus").addEventListener(CLICK,this.useDisqus)},e.loadDsqjs=function(){var m=this;this.msg("评论基础模式加载中... "+HTML_TPL_EL_ASK_FOR_FULL),this.assignClickEventForAskForFulButton();var s=this.config.api+"3.0/threads/list.json?forum="+encodeURIComponent(this.config.shortname)+"&thread="+encodeURIComponent("ident:"+this.config.identifier)+"&api_key="+encodeURIComponent(this.apikey());this._get(s).then(function(s){var e=s.data;if(0===e.code&&1===e.response.length){var t=e.response[0],n=t.id,o=t.title,i=t.isClosed,r=t.posts;m.page={id:n,title:o,isClosed:i,length:r,comment:[]},$$(DISQUS_CONTAINER_EL_ID).innerHTML='<div id="dsqjs"><div id="dsqjs-msg">评论基础模式加载中... '+HTML_TPL_EL_ASK_FOR_FULL+"</div>"+HTML_TPL_EL_HEADER(r,m.config.siteName)+'<section class="dsqjs-post-container"><ul class="dsqjs-post-list" id="dsqjs-post-container"><p class="dsqjs-no-comment">评论列表加载中...</p></ul><a id="dsqjs-load-more" class="dsqjs-load-more dsqjs-hide">加载更多评论</a></section>'+HTML_TPL_EL_FOOTER+"</div>",m.assignClickEventForAskForFulButton(),$$("dsqjs-order-"+m.sortType).setAttribute("checked","true"),a()}else{if(0!==e.code||1===e.response.length)throw new Error;m.msg('当前 Thread 尚未创建。是否切换至 <a id="dsqjs-force-disqus" class="dsqjs-msg-btn">完整 Disqus 模式</a>？'),$$("dsqjs-force-disqus").addEventListener(CLICK,m.useDisqus)}}).catch(this.loadError);function e(s){function n(s){return{comment:s,author:s.author.name,isPrimary:!!m.config.admin&&s.author.username===m.config.admin,children:t(+s.id),hasMore:s.hasMore}}var e=[],o=[],t=function(e){if(0===o.length)return null;var t=[];return o.forEach(function(s){s.parent===e&&t.unshift(n(s))}),t.length?t:null};return s.forEach(function(s){(s.parent?o:e).push(s)}),e.map(n)}var a=function t(s){void 0===s&&(s="");function n(){Array.prototype.slice.call(i).forEach(function(s){return s.removeEventListener("change",d)}),o.removeEventListener(CLICK,a),Array.prototype.slice.call(r).forEach(function(s){return s.removeEventListener(CLICK,m.checkDisqus)})}var o=$$("dsqjs-load-more"),i=document.getElementsByClassName("dsqjs-order-radio"),r=document.getElementsByClassName("dsqjs-has-more-btn"),a=function(){n(),t(m.page.next)},d=function(s){var e=s.target;m.sortType=e.getAttribute("value"),setLS(DSQJS_STORAGE_KEY_SORT_TYPE,m.sortType),n(),m.page.comment=[],m.page.next="",$$("dsqjs-post-container").innerHTML='<p class="dsqjs-no-comment">正在切换排序方式...</p>',o.classList.add("dsqjs-hide"),t()},e=""===s?"":"&cursor="+s;o.classList.add("dsqjs-disabled");function c(s){var e=s.createdAt;return Date.parse(new Date(e).toString())}function l(s,e){return s.parent&&e.parent?c(s)-c(e):0}var u=m.config.api+"3.0/threads/listPostsThreaded?forum="+encodeURIComponent(m.config.shortname)+"&thread="+encodeURIComponent(m.page.id||"")+encodeURIComponent(e)+"&api_key="+encodeURIComponent(m.apikey())+"&order="+encodeURIComponent(m.sortType);m._get(u).then(function(s){var e=s.data;if(0===e.code&&0<e.response.length){var t,n;o.classList.remove("dsqjs-disabled"),null==(t=m.page.comment)||t.push.apply(t,e.response),null==(n=m.page.comment)||n.sort(l),q(m.page.comment),Array.prototype.slice.call(i).forEach(function(s){return s.addEventListener("change",d)}),Array.prototype.slice.call(r).forEach(function(s){return s.addEventListener(CLICK,m.checkDisqus)}),e.cursor.hasNext?(m.page.next=e.cursor.next,o.innerHTML="加载更多评论",o.classList.remove("dsqjs-hide"),o.addEventListener(CLICK,a)):o.classList.add("dsqjs-hide")}else{if(0!==e.code||0!==e.response.length)throw new Error;m.msg("你可能无法访问 Disqus，已启用评论基础模式。"+HTML_TPL_EL_ASK_FOR_FULL),$$("dsqjs-post-container").innerHTML='<p class="dsqjs-no-comment" >'+m.config.nocomment+"</p>",m.assignClickEventForAskForFulButton(),$$("dsqjs-force-disqus").addEventListener(CLICK,m.useDsqjs)}}).catch(function(){""===s?m.loadError():(o.classList.remove("dsqjs-disabled"),o.innerHTML="加载更多评论失败，点击重试",o.addEventListener(CLICK,a))})},q=function(s){function i(s){return s.comment.author.profileUrl?(s.comment.avatarEl='<a href="'+s.comment.author.profileUrl+'" '+HTML_TPL_A_ATTR+'><img src="'+n(s.comment.author.avatar.cache)+'"></a>',s.comment.authorEl='<span class="dsqjs-post-author"><a href="'+s.comment.author.profileUrl+'" '+HTML_TPL_A_ATTR+">"+s.comment.author.name+"</a></span>"):(s.comment.avatarEl='<img src="'+n(s.comment.author.avatar.cache)+'">',s.comment.authorEl='<span class="dsqjs-post-author">'+s.comment.author.name+"</span>"),m.config.adminLabel&&s.isPrimary&&(s.comment.authorEl+='<span class="dsqjs-admin-badge">'+m.config.adminLabel+"</span>"),s}function r(s){var e="",t="";return t=s.isDeleted?"<small>此评论已被删除</small>":(e=s.authorEl+'<span class="dsqjs-bullet"></span>',function(s){var e=document.createElement("div");e.innerHTML=s;var t=e.getElementsByTagName("a");return Array.prototype.slice.call(t).forEach(function(s){var e=decodeURIComponent(s.href.replace(/https:\/\/disq\.us\/url\?url=/g,"")).replace(/(.*):.+cuid=.*/,"$1");s.href=e,s.innerHTML=e,s.rel="external noopener nofollow noreferrer",s.target="_blank"}),e.innerHTML}(n(s.message))),HTML_TPL_EL_COMMENT(s,e,t)}var n=function(s){return s.replace(/a\.disquscdn\.com/g,"c.disquscdn.com")},t="";e(s).map(function(s){s.children&&(s.nesting=1);var e="";(s=i(s)).hasMore&&(e='<p class="dsqjs-has-more">切换至 <a id="load-more-'+s.comment.id+'">完整 Disqus 模式</a> 显示更多回复</p>'),t+='<li data-id="comment-'+s.comment.id+'" id="comment-'+s.comment.id+'">'+r(s.comment)+function t(s){var n=s.nesting,e=s.children||[];if(e){var o="";return o=n<m.config.nesting?'<ul class="dsqjs-post-list dsqjs-children">':'<ul class="dsqjs-post-list">',e.map(function(s){(s=i(s)).nesting=n+1;var e=s.hasMore?'<p class="dsqjs-has-more">切换至 <a class="dsqjs-has-more-btn" id="load-more-'+s.comment.id+'" data-more-id="comment-'+s.comment.id+'">完整 Disqus 模式</a> 显示更多回复</p>':"";o+='<li data-id="comment-'+s.comment.id+'" id="comment-'+s.comment.id+'">'+r(s.comment)+t(s)+e+"</li>"}),0!==(o+="</ul>").length?o:void 0}}(s)+e+"</li>"}),m.msg("你可能无法访问 Disqus，已启用评论基础模式。"+HTML_TPL_EL_ASK_FOR_FULL),$$("dsqjs-post-container").innerHTML=t,m.assignClickEventForAskForFulButton()}},e.loadError=function(s){console.log(s),this.msg('评论基础模式加载失败，是否 <a id="dsqjs-reload-dsqjs" class="dsqjs-msg-btn">重载</a> 或 <a id="dsqjs-reload-disqus" class="dsqjs-msg-btn">尝试完整 Disqus 模式</a> ？'),$$("dsqjs-reload-dsqjs").addEventListener(CLICK,this.loadDsqjs),$$("dsqjs-reload-disqus").addEventListener(CLICK,this.checkDisqus)},e.apikey=function(){var s=this.config.apikey;return Array.isArray(s)?s[Math.floor(Math.random()*s.length)]:s},e.initDsqjs=function(){this.mode=localStorage.getItem("dsqjs_mode"),this.sortType=localStorage.getItem(DSQJS_STORAGE_KEY_SORT_TYPE)||localStorage.getItem("disqus.sort"),this.sortType||(setLS(DSQJS_STORAGE_KEY_SORT_TYPE,"desc"),this.sortType="desc"),"disqus"===this.mode?this.loadDisqus():"dsqjs"===this.mode?this.loadDsqjs():this.checkDisqus()},s}(),_default=DisqusJS;exports.default=_default;